<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secret Fall</title>
  <style>
    :root {
      --sky-top: #89c7ff;
      --sky-bottom: #0f2a4d;
      --building: #2a2a3b;
      --window: #7cc7ff;
      --person: #f3f3f3;
      --hazard: #f8a30b;
      --hud: rgba(0, 0, 0, 0.35);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      min-height: 100vh;
      overflow: hidden;
      font-family: "Courier New", monospace;
      background: radial-gradient(circle at top, #1d3b6e 0%, #081324 75%);
      color: #fff;
    }

    #scene {
      display: block;
      width: 100vw;
      height: 100vh;
    }

    .label {
      position: fixed;
      top: 14px;
      left: 14px;
      background: var(--hud);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      user-select: none;
      pointer-events: none;
    }

    .music-btn {
      position: fixed;
      top: 14px;
      right: 14px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.45);
      color: #fff;
      font-family: inherit;
      font-size: 12px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      padding: 8px 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <canvas id="scene" aria-label="A looping fall animation"></canvas>
  <div class="label">Secret Mode: Keep Falling</div>
  <button id="musicBtn" class="music-btn" type="button">Music On</button>
  <audio id="music" autoplay loop preload="auto">
    <source src="../Tech%20Flow.mp3" type="audio/mpeg" />
  </audio>

  <script>
    const canvas = document.getElementById("scene");
    const ctx = canvas.getContext("2d");

    const person = {
      x: 0,
      y: 0,
      vy: 0,
      walkSpeed: 120,
      gravity: 560,
      state: "walking",
      legPhase: 0,
      floorY: 0,
      windowX: 0,
      windowY: 0,
      jumpTimer: 0,
      timeFalling: 0,
      totalDistance: 0,
      bob: 0,
    };

    let worldOffset = 0;
    let lastTime = 0;
    let hazards = [];

    function resize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      person.floorY = Math.floor(canvas.height * 0.32);
      person.windowX = Math.floor(canvas.width * 0.38);
      person.windowY = person.floorY - 16;

      if (person.state === "walking") {
        person.x = Math.max(24, canvas.width * 0.12);
        person.y = person.floorY;
      }

      if (person.state === "falling" || person.state === "jumping") {
        person.x = person.windowX + 10;
      }

      createHazards();
    }

    function createHazards() {
      hazards = [];
      for (let i = 0; i < 38; i++) {
        const size = 20 + Math.random() * 42;
        hazards.push({
          x: 30 + Math.random() * (canvas.width - 60),
          y: 240 + i * (170 + Math.random() * 140),
          w: size,
          h: size * (0.4 + Math.random() * 0.8),
          vx: (Math.random() - 0.5) * 22,
          hue: 25 + Math.random() * 45,
          twirl: Math.random() * Math.PI * 2,
        });
      }
    }

    function drawBuilding() {
      const top = -worldOffset + person.floorY - 140;
      const bX = canvas.width * 0.18;
      const bW = canvas.width * 0.45;

      ctx.fillStyle = "#2b2b3f";
      ctx.fillRect(bX, top, bW, 170);

      ctx.fillStyle = "#202031";
      for (let i = 0; i < 6; i++) {
        const winX = bX + 30 + i * ((bW - 60) / 6);
        for (let r = 0; r < 3; r++) {
          const winY = top + 24 + r * 38;
          ctx.fillRect(winX, winY, 20, 18);
        }
      }

      ctx.fillStyle = "#86d8ff";
      const windowY = -worldOffset + person.windowY - 25;
      ctx.fillRect(person.windowX, windowY, 34, 30);
    }

    function drawPerson() {
      const px = person.x;
      const py = person.state === "falling" ? (canvas.height * 0.38 + person.bob) : (person.y - worldOffset + person.bob);
      const leg = Math.sin(person.legPhase) * 7;

      ctx.strokeStyle = "#f5f5f5";
      ctx.lineWidth = 3;
      ctx.lineCap = "round";

      ctx.beginPath();
      ctx.arc(px, py - 20, 6, 0, Math.PI * 2);
      ctx.stroke();

      ctx.beginPath();
      ctx.moveTo(px, py - 14);
      ctx.lineTo(px, py + 6);
      ctx.moveTo(px, py - 4);
      ctx.lineTo(px - 9, py + 2);
      ctx.moveTo(px, py - 4);
      ctx.lineTo(px + 9, py + 2);
      ctx.moveTo(px, py + 6);
      ctx.lineTo(px - 6, py + 16 + leg);
      ctx.moveTo(px, py + 6);
      ctx.lineTo(px + 6, py + 16 - leg);
      ctx.stroke();
    }

    function drawHazards(dt) {
      const recycleThreshold = -120;

      for (const hz of hazards) {
        hz.twirl += dt * 2;

        const onScreenY = hz.y - worldOffset;
        if (onScreenY < recycleThreshold) {
          hz.y = worldOffset + canvas.height + 120 + Math.random() * 320;
          hz.x = 30 + Math.random() * (canvas.width - 60);
        }

        if (hz.x < 12 || hz.x > canvas.width - 12) {
          hz.vx *= -1;
        }

        hz.x += hz.vx * dt;

        ctx.save();
        ctx.translate(hz.x, onScreenY);
        ctx.rotate(Math.sin(hz.twirl) * 0.7);
        ctx.fillStyle = `hsl(${hz.hue} 88% 54%)`;
        ctx.fillRect(-hz.w / 2, -hz.h / 2, hz.w, hz.h);
        ctx.restore();

        const dx = Math.abs(person.x - hz.x);
        const personScreenY = person.state === "falling" ? canvas.height * 0.38 : (person.y - worldOffset);
        const dy = Math.abs(personScreenY - onScreenY);
        if (dx < hz.w * 0.5 + 6 && dy < hz.h * 0.5 + 12) {
          person.vy *= -0.45;
          person.x += (Math.random() - 0.5) * 24;
        }
      }
    }

    function step(dt) {
      if (person.state === "walking") {
        person.x += person.walkSpeed * dt;
        person.legPhase += dt * 10;
        person.bob = Math.sin(person.legPhase * 2) * 1.5;

        if (person.x >= person.windowX + 8) {
          person.state = "jumping";
          person.jumpTimer = 0;
          person.vy = -280;
        }
      } else if (person.state === "jumping") {
        person.jumpTimer += dt;
        person.vy += person.gravity * dt;
        person.y += person.vy * dt;

        if (person.jumpTimer > 0.55) {
          person.state = "falling";
          person.vy = 70;
          person.timeFalling = 0;
        }
      } else {
        person.timeFalling += dt;
        person.legPhase += dt * 7;
        person.bob = Math.sin(person.legPhase * 2.6) * 1.5;
        person.vy += person.gravity * dt;
        person.totalDistance += person.vy * dt;
        worldOffset += person.vy * dt;

        person.x += Math.sin(person.timeFalling * 2.2) * 45 * dt;
        person.x = Math.min(Math.max(person.x, 18), canvas.width - 18);
      }
    }

    function drawBackground() {
      const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
      grad.addColorStop(0, "#8ed0ff");
      grad.addColorStop(0.35, "#4f8ec0");
      grad.addColorStop(1, "#122741");
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      for (let i = 0; i < 60; i++) {
        const starX = (i * 173) % canvas.width;
        const starY = ((i * 97) + (worldOffset * 0.03)) % canvas.height;
        ctx.fillStyle = "rgba(255,255,255,0.35)";
        ctx.fillRect(starX, starY, 2, 2);
      }
    }

    function frame(ts) {
      if (!lastTime) lastTime = ts;
      const dt = Math.min((ts - lastTime) / 1000, 0.033);
      lastTime = ts;

      step(dt);

      drawBackground();
      drawBuilding();
      drawHazards(dt);
      drawPerson();

      requestAnimationFrame(frame);
    }

    window.addEventListener("resize", resize);
    resize();
    requestAnimationFrame(frame);

    const music = document.getElementById("music");
    const musicBtn = document.getElementById("musicBtn");
    music.volume = 0.55;

    function enableMusic() {
      music.play().then(() => {
        musicBtn.textContent = "Music On";
      }).catch(() => {
        musicBtn.textContent = "Tap to Start Music";
      });
    }

    musicBtn.addEventListener("click", () => {
      if (music.paused) {
        enableMusic();
      } else {
        music.pause();
        musicBtn.textContent = "Music Off";
      }
    });

    window.addEventListener("click", () => {
      if (music.paused) {
        enableMusic();
      }
    }, { once: true });
    window.addEventListener("keydown", () => {
      if (music.paused) {
        enableMusic();
      }
    }, { once: true });

    if (music.paused) {
      musicBtn.textContent = "Tap to Start Music";
    }
  </script>
</body>
</html>
